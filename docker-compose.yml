services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: always
    pull_policy: always

    ports:
      - "80:80"
      - "443:443"

    command:
      # Dashboard & providers
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.certresolver=cloudflare
      - --entrypoints.websecure.http.tls.domains[0].main=link.il1.nl
      - --entrypoints.websecure.http.tls.domains[0].sans=*.link.il1.nl

      # ACME (Cloudflare DNSâ€‘01)
      - --certificatesresolvers.cloudflare.acme.dnschallenge=true
      - --certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53
      - --certificatesresolvers.cloudflare.acme.email=baris.dogu@icloud.com
      - --certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json

      - --log.level=INFO

    environment:
      CF_DNS_API_TOKEN: <YOUR_CLOUDFLARE_API_TOKEN>

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./letsencrypt:/letsencrypt

    networks:
      - traefik_proxy

    labels:
      traefik.enable: "true"
      traefik.http.routers.mydashboard.rule: "Host(`traefik.vultr.llll.ist`)"
      traefik.http.routers.mydashboard.entrypoints: "websecure"
      traefik.http.routers.mydashboard.service: "api@internal"
      traefik.http.routers.mydashboard.tls: "true"
      traefik.http.routers.mydashboard.middlewares: "myauth"
      traefik.http.middlewares.myauth.basicauth.users: "test:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/"

  tunnelr:
    image: ghcr.io/bariiss/tunnelr:latest
    container_name: tunnelr
    restart: always
    pull_policy: always
    expose:
      - "8095"
    networks:
      - traefik_proxy
    environment:
      - SERVER_PORT=8095
      - BASE_DOMAIN=link.il1.nl

    labels:
      traefik.enable: "true"

      traefik.http.services.tunnelr.loadbalancer.server.port: "8095"

      traefik.http.routers.tunnelr.rule: "Host(`link.il1.nl`)"
      traefik.http.routers.tunnelr.entrypoints: "websecure"
      traefik.http.routers.tunnelr.tls.certresolver: "cloudflare"
      traefik.http.routers.tunnelr.service: "tunnelr"

      traefik.http.routers.tunnelr-sub.rule: "HostRegexp(`{subdomain:[a-z0-9]+}.link.il1.nl`)"
      traefik.http.routers.tunnelr-sub.entrypoints: "websecure"
      traefik.http.routers.tunnelr-sub.tls.certresolver: "cloudflare"
      traefik.http.routers.tunnelr-sub.service: "tunnelr"
      traefik.http.routers.tunnelr-sub.tls.domains[0].main: "link.il1.nl"
      traefik.http.routers.tunnelr-sub.tls.domains[0].sans: "*.link.il1.nl"

      com.centurylinklabs.watchtower.enable: "true"
    depends_on:
      - traefik

networks:
  traefik_proxy:
    external: true
    name: traefik_proxy